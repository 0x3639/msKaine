import{_ as t,o,c as i,ag as d}from"./chunks/framework.DEqXEGcv.js";const p=JSON.parse('{"title":"Security Audit Report","description":"","frontmatter":{},"headers":[],"relativePath":"security-audit.md","filePath":"security-audit.md"}'),r={name:"security-audit.md"};function n(a,e,s,c,l,u){return o(),i("div",null,[...e[0]||(e[0]=[d('<h1 id="security-audit-report" tabindex="-1">Security Audit Report <a class="header-anchor" href="#security-audit-report" aria-label="Permalink to &quot;Security Audit Report&quot;">​</a></h1><p><strong>Date</strong>: 2026-02-21 <strong>Branch</strong>: <code>feature/security-fixes</code><strong>Auditor</strong>: Claude (Senior Security Researcher)</p><hr><h2 id="summary" tabindex="-1">Summary <a class="header-anchor" href="#summary" aria-label="Permalink to &quot;Summary&quot;">​</a></h2><p>Comprehensive security audit of the Ms. Kaine Admin Bot codebase. Identified 10 vulnerabilities across input handling, authentication/authorization, secrets management, DoS vectors, and infrastructure.</p><table tabindex="0"><thead><tr><th>#</th><th>Vulnerability</th><th>Severity</th><th>Status</th></tr></thead><tbody><tr><td>1</td><td>Echo HTML injection</td><td>HIGH</td><td>Accepted (by design for admins)</td></tr><tr><td>2</td><td>Incomplete <code>escapeHtml()</code></td><td>MEDIUM</td><td><strong>Fixed</strong></td></tr><tr><td>3</td><td>ReDoS in blocklist glob/homoglyph</td><td>HIGH</td><td><strong>Fixed</strong></td></tr><tr><td>4</td><td>Federation import — no size/count limit</td><td>MEDIUM</td><td><strong>Fixed</strong></td></tr><tr><td>5</td><td>Unbounded purge (no max cap)</td><td>MEDIUM</td><td><strong>Fixed</strong></td></tr><tr><td>6</td><td>Mnemonic exposure in error logs</td><td>CRITICAL</td><td><strong>Fixed</strong></td></tr><tr><td>7</td><td>PM connection — no admin revalidation</td><td>MEDIUM</td><td><strong>Fixed</strong></td></tr><tr><td>8</td><td>Wallet auto-verify without on-chain proof</td><td>HIGH</td><td>Deferred (Zenon feature)</td></tr><tr><td>9</td><td>Dockerfile missing explicit non-root USER</td><td>LOW</td><td><strong>Fixed</strong></td></tr><tr><td>10</td><td>Redis without password in Docker</td><td>LOW</td><td><strong>Fixed</strong></td></tr></tbody></table><hr><h2 id="findings-detail" tabindex="-1">Findings Detail <a class="header-anchor" href="#findings-detail" aria-label="Permalink to &quot;Findings Detail&quot;">​</a></h2><h3 id="_1-echo-html-injection-high-—-accepted-risk" tabindex="-1">1. Echo HTML Injection (HIGH — Accepted Risk) <a class="header-anchor" href="#_1-echo-html-injection-high-—-accepted-risk" aria-label="Permalink to &quot;1. Echo HTML Injection (HIGH — Accepted Risk)&quot;">​</a></h3><p><strong>File</strong>: <code>src/modules/echo/index.ts</code></p><p><strong>Description</strong>: The <code>/echo</code> and <code>/say</code> commands pass user text directly to <code>ctx.reply(text, { parse_mode: &quot;HTML&quot; })</code> without escaping. An admin can inject arbitrary HTML tags.</p><p><strong>Decision</strong>: This is intentionally designed for admin use — admins use <code>/echo</code> to send formatted messages with bold, italic, links, etc. The command is already guarded by <code>requireAdmin()</code>. Documented as accepted risk.</p><h3 id="_2-incomplete-escapehtml-medium-—-fixed" tabindex="-1">2. Incomplete <code>escapeHtml()</code> (MEDIUM — Fixed) <a class="header-anchor" href="#_2-incomplete-escapehtml-medium-—-fixed" aria-label="Permalink to &quot;2. Incomplete `escapeHtml()` (MEDIUM — Fixed)&quot;">​</a></h3><p><strong>File</strong>: <code>src/utils/message-builder.ts</code></p><p><strong>Description</strong>: The <code>escapeHtml()</code> function only escaped <code>&amp;</code>, <code>&lt;</code>, and <code>&gt;</code> but not <code>&quot;</code> and <code>&#39;</code>. While Telegram&#39;s HTML parse mode is limited, incomplete escaping could allow attribute breakout in edge cases where escaped text is used inside HTML attributes.</p><p><strong>Fix</strong>: Added <code>.replace(/&quot;/g, &quot;&amp;quot;&quot;)</code> and <code>.replace(/&#39;/g, &quot;&amp;#39;&quot;)</code>.</p><h3 id="_3-redos-in-blocklist-high-—-fixed" tabindex="-1">3. ReDoS in Blocklist (HIGH — Fixed) <a class="header-anchor" href="#_3-redos-in-blocklist-high-—-fixed" aria-label="Permalink to &quot;3. ReDoS in Blocklist (HIGH — Fixed)&quot;">​</a></h3><p><strong>File</strong>: <code>src/modules/blocklist/index.ts</code></p><p><strong>Description</strong>: Two ReDoS vectors:</p><ol><li>Glob-to-regex conversion used <code>trigger.replace(/\\*/g, &quot;.*&quot;)</code> creating unbounded <code>.*</code> patterns. A trigger like <code>*a*a*a*a*</code> causes catastrophic backtracking.</li><li><code>containsLookalike()</code> builds complex regex from homoglyph character classes that can cause exponential backtracking.</li></ol><p><strong>Fix</strong>:</p><ul><li>Added 100-character limit on blocklist trigger length at add time</li><li>Changed glob <code>*</code> conversion from <code>.*</code> (greedy) to <code>[^/]*?</code> (lazy, bounded)</li><li>Wrapped all regex tests with input length bounds (text capped at 1000 chars for regex matching)</li><li>Added try/catch around regex operations to prevent crashes</li></ul><h3 id="_4-federation-import-—-no-size-count-limit-medium-—-fixed" tabindex="-1">4. Federation Import — No Size/Count Limit (MEDIUM — Fixed) <a class="header-anchor" href="#_4-federation-import-—-no-size-count-limit-medium-—-fixed" aria-label="Permalink to &quot;4. Federation Import — No Size/Count Limit (MEDIUM — Fixed)&quot;">​</a></h3><p><strong>File</strong>: <code>src/modules/federations/index.ts</code></p><p><strong>Description</strong>: <code>/importfbans</code> downloaded files with no size check, parsed unbounded JSON, and processed unlimited ban entries. Could cause memory exhaustion with large files.</p><p><strong>Fix</strong>:</p><ul><li>Added 5MB file size check before download</li><li>Limited import to 10,000 ban entries</li><li>Added validation that each entry has a valid <code>user_id</code> number</li><li>Better error handling with specific error messages</li></ul><h3 id="_5-unbounded-purge-medium-—-fixed" tabindex="-1">5. Unbounded Purge (MEDIUM — Fixed) <a class="header-anchor" href="#_5-unbounded-purge-medium-—-fixed" aria-label="Permalink to &quot;5. Unbounded Purge (MEDIUM — Fixed)&quot;">​</a></h3><p><strong>File</strong>: <code>src/modules/purges/index.ts</code></p><p><strong>Description</strong>: Without an explicit count argument, <code>/purge</code> would delete all messages between the reply and the command. In busy chats, the message ID range could span thousands.</p><p><strong>Fix</strong>: Added 200-message hard cap. If the range exceeds 200 messages and no explicit count was provided, the bot warns the admin and refuses to proceed.</p><h3 id="_6-mnemonic-exposure-in-error-logs-critical-—-fixed" tabindex="-1">6. Mnemonic Exposure in Error Logs (CRITICAL — Fixed) <a class="header-anchor" href="#_6-mnemonic-exposure-in-error-logs-critical-—-fixed" aria-label="Permalink to &quot;6. Mnemonic Exposure in Error Logs (CRITICAL — Fixed)&quot;">​</a></h3><p><strong>File</strong>: <code>src/core/zenon-client.ts</code></p><p><strong>Description</strong>: If <code>KeyStore.fromMnemonic()</code> threw an exception, the error object (which may contain the mnemonic in its message or stack trace) was logged via <code>log.error({ err }, &quot;...&quot;)</code>. Pino serializes the full error object including message and stack.</p><p><strong>Fix</strong>: Wrapped mnemonic usage in a nested try/catch that only logs <code>err.message</code> (as a string), never the full error object. Same pattern applied in wallet handler.</p><h3 id="_7-pm-connection-—-no-admin-revalidation-medium-—-fixed" tabindex="-1">7. PM Connection — No Admin Revalidation (MEDIUM — Fixed) <a class="header-anchor" href="#_7-pm-connection-—-no-admin-revalidation-medium-—-fixed" aria-label="Permalink to &quot;7. PM Connection — No Admin Revalidation (MEDIUM — Fixed)&quot;">​</a></h3><p><strong>File</strong>: <code>src/middleware/connection.middleware.ts</code></p><p><strong>Description</strong>: Once a PM connection was established, it persisted indefinitely. A user removed from admin or removed from the chat entirely could continue operating via their PM connection.</p><p><strong>Fix</strong>: Added admin status revalidation via <code>getChatMember</code> API call on every PM request that uses a connection. If the user is no longer an admin (or not in the chat), the connection is deactivated.</p><h3 id="_8-wallet-auto-verify-high-—-deferred" tabindex="-1">8. Wallet Auto-Verify (HIGH — Deferred) <a class="header-anchor" href="#_8-wallet-auto-verify-high-—-deferred" aria-label="Permalink to &quot;8. Wallet Auto-Verify (HIGH — Deferred)&quot;">​</a></h3><p><strong>File</strong>: <code>src/modules/zenon/wallet.handler.ts</code></p><p><strong>Description</strong>: Wallet verification auto-verifies on <code>/zwallet verify</code> without checking for an on-chain transaction proving ownership. Any user can claim any Zenon address.</p><p><strong>Status</strong>: Deferred — this was already identified in the roadmap audit. Proper fix requires on-chain transaction verification which is a substantial Zenon integration task.</p><h3 id="_9-dockerfile-missing-non-root-user-low-—-fixed" tabindex="-1">9. Dockerfile Missing Non-Root USER (LOW — Fixed) <a class="header-anchor" href="#_9-dockerfile-missing-non-root-user-low-—-fixed" aria-label="Permalink to &quot;9. Dockerfile Missing Non-Root USER (LOW — Fixed)&quot;">​</a></h3><p><strong>File</strong>: <code>Dockerfile</code></p><p><strong>Description</strong>: While <code>node:20-alpine</code> doesn&#39;t run as root by default in all configurations, best practice is to explicitly set <code>USER node</code> to ensure the container never runs as root.</p><p><strong>Fix</strong>: Added <code>USER node</code> directive in the production stage.</p><h3 id="_10-redis-without-password-low-—-fixed" tabindex="-1">10. Redis Without Password (LOW — Fixed) <a class="header-anchor" href="#_10-redis-without-password-low-—-fixed" aria-label="Permalink to &quot;10. Redis Without Password (LOW — Fixed)&quot;">​</a></h3><p><strong>File</strong>: <code>docker-compose.yml</code></p><p><strong>Description</strong>: Redis was running without authentication. In a compromised network, any process could connect to Redis and read/modify cached data.</p><p><strong>Fix</strong>: Added <code>REDIS_PASSWORD</code> environment variable support. Redis now starts with <code>--requirepass</code> when a password is set. Updated <code>.env.example</code> and Redis URL format.</p>',51)])])}const g=t(r,[["render",n]]);export{p as __pageData,g as default};
